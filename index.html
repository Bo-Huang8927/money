<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能收支记录系统</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入Tesseract.js用于OCR识别 -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        expense: '#EF4444',
                        income: '#10B981',
                        neutral: '#6B7280'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .transition-custom {
                transition: all 0.3s ease;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-md fixed w-full top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-money text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">智能收支记录系统</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="statsBtn" class="flex items-center space-x-1 px-3 py-2 rounded-md hover:bg-gray-100 transition-custom">
                    <i class="fa fa-bar-chart text-primary"></i>
                    <span class="hidden md:inline">统计分析</span>
                </button>
                <button id="exportBtn" class="flex items-center space-x-1 px-3 py-2 rounded-md hover:bg-gray-100 transition-custom">
                    <i class="fa fa-download text-primary"></i>
                    <span class="hidden md:inline">导出数据</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 pt-24 pb-16">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左侧表单区域 -->
            <div class="lg:col-span-1 space-y-6">
                <!-- 添加记录表单 -->
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fa fa-pencil-square-o text-primary mr-2"></i>添加收支记录
                    </h2>
                    
                    <form id="transactionForm" class="space-y-4">
                        <input type="hidden" id="transactionId">
                        
                        <!-- 日期 -->
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                            <input type="date" id="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom">
                        </div>
                        
                        <!-- 金额 -->
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">金额 (¥)</label>
                            <input type="number" id="amount" step="0.01" min="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom" placeholder="请输入金额">
                        </div>
                        
                        <!-- 类型 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">类型</label>
                            <div class="flex space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="type" value="expense" checked class="text-expense focus:ring-expense">
                                    <span class="ml-2 text-expense">支出</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="type" value="income" class="text-income focus:ring-income">
                                    <span class="ml-2 text-income">收入</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- 分类 -->
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700 mb-1">分类</label>
                            <select id="category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom">
                                <!-- 分类选项将通过JavaScript动态生成 -->
                            </select>
                        </div>
                        
                        <!-- 描述 -->
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">描述</label>
                            <input type="text" id="description" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom" placeholder="请输入描述信息">
                        </div>
                        
                        <!-- 按钮组 -->
                        <div class="flex flex-wrap gap-3 pt-2">
                            <button type="submit" class="flex-1 bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg transition-custom flex items-center justify-center">
                                <i class="fa fa-save mr-2"></i>保存记录
                            </button>
                            <button type="button" id="clearFormBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition-custom flex items-center justify-center">
                                <i class="fa fa-eraser mr-2"></i>清空表单
                            </button>
                            <button type="button" id="importImageBtn" class="w-full md:w-auto bg-gray-800 hover:bg-gray-900 text-white py-2 px-4 rounded-lg transition-custom flex items-center justify-center">
                                <i class="fa fa-picture-o mr-2"></i>从图片导入
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- 图片上传区域 -->
                <div class="bg-white rounded-xl p-6 card-shadow hidden" id="imageUploadSection">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fa fa-camera text-primary mr-2"></i>图片识别
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- 图片上传控件 -->
                        <div>
                            <label for="imageUpload" class="block text-sm font-medium text-gray-700 mb-2">选择图片</label>
                            <input type="file" id="imageUpload" accept="image/*" class="w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-lg file:border-0
                                file:text-sm file:font-medium
                                file:bg-primary file:text-white
                                hover:file:bg-primary/90 transition-custom">
                        </div>
                        
                        <!-- 图片预览 -->
                        <div id="imagePreviewContainer" class="hidden">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">图片预览</h3>
                            <div class="border border-gray-200 rounded-lg overflow-hidden bg-gray-50">
                                <img id="imagePreview" src="" alt="图片预览" class="w-full h-auto max-h-64 object-contain">
                            </div>
                        </div>
                        
                        <!-- 识别按钮和进度 -->
                        <div id="ocrControls" class="hidden">
                            <button id="processImageBtn" class="w-full bg-secondary hover:bg-secondary/90 text-white py-2 px-4 rounded-lg transition-custom flex items-center justify-center">
                                <i class="fa fa-magic mr-2"></i>开始识别
                            </button>
                            
                            <div id="ocrProgress" class="hidden mt-4">
                                <div class="text-sm font-medium text-gray-700 mb-1">识别进度</div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="ocrProgressBar" class="bg-secondary h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                                <p id="ocrStatus" class="text-sm text-gray-500 mt-1">准备中...</p>
                            </div>
                        </div>
                        
                        <!-- 识别结果 -->
                        <div id="ocrResults" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">识别结果</h3>
                            <div class="space-y-2 text-sm">
                                <p><span class="font-medium">日期:</span> <span id="ocrDate">- 未识别 -</span></p>
                                <p><span class="font-medium">金额:</span> <span id="ocrAmount">- 未识别 -</span></p>
                                <p><span class="font-medium">类型:</span> <span id="ocrType">- 未识别 -</span></p>
                            </div>
                            <button id="applyOcrResultsBtn" class="mt-3 text-sm bg-primary hover:bg-primary/90 text-white py-1 px-3 rounded-lg transition-custom">
                                应用到表单
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧记录列表 -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl p-6 card-shadow h-full">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                        <h2 class="text-xl font-bold mb-4 md:mb-0 flex items-center">
                            <i class="fa fa-list-alt text-primary mr-2"></i>收支记录列表
                        </h2>
                        
                        <!-- 搜索和筛选 -->
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="relative">
                                <input type="text" id="searchInput" placeholder="搜索描述..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom w-full sm:w-64">
                                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            
                            <select id="filterType" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom">
                                <option value="all">全部类型</option>
                                <option value="expense">只看支出</option>
                                <option value="income">只看收入</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 记录列表 -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">日期</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">描述</th>
                                    <th class="px-4 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">操作</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- 记录将通过JavaScript动态生成 -->
                                <tr class="text-center">
                                    <td colspan="6" class="px-4 py-12 text-gray-500">
                                        <div class="flex flex-col items-center">
                                            <i class="fa fa-folder-open-o text-4xl mb-3 text-gray-300"></i>
                                            <p>暂无收支记录</p>
                                            <p class="text-sm mt-1">添加您的第一条收支记录吧</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页 -->
                    <div class="flex items-center justify-between mt-6">
                        <div class="text-sm text-gray-500">
                            显示 <span id="shownCount">0</span> 条，共 <span id="totalCount">0</span> 条记录
                        </div>
                        <div class="flex space-x-2">
                            <button id="prevPageBtn" class="px-3 py-1 border border-gray-300 rounded-md text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-custom" disabled>
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            <span id="pageInfo" class="px-3 py-1 text-gray-600">第 1 页</span>
                            <button id="nextPageBtn" class="px-3 py-1 border border-gray-300 rounded-md text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-custom" disabled>
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 统计分析模态框 -->
    <div id="statsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold flex items-center">
                    <i class="fa fa-bar-chart text-primary mr-2"></i>收支统计分析
                </h3>
                <button id="closeStatsBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6">
                <!-- 时间筛选 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">选择时间段</label>
                    <div class="flex flex-wrap gap-3">
                        <button class="time-filter-btn px-4 py-2 bg-primary text-white rounded-lg" data-period="month">本月</button>
                        <button class="time-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg" data-period="quarter">本季度</button>
                        <button class="time-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg" data-period="year">本年</button>
                        <button class="time-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg" data-period="all">全部</button>
                    </div>
                </div>
                
                <!-- 概览统计 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-sm text-gray-500 mb-1">总收入</p>
                        <p class="text-2xl font-bold text-income" id="totalIncome">¥0.00</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-sm text-gray-500 mb-1">总支出</p>
                        <p class="text-2xl font-bold text-expense" id="totalExpense">¥0.00</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-sm text-gray-500 mb-1">结余</p>
                        <p class="text-2xl font-bold text-primary" id="balance">¥0.00</p>
                    </div>
                </div>
                
                <!-- 图表区域 -->
                <div class="space-y-8">
                    <!-- 收支趋势图 -->
                    <div>
                        <h4 class="text-lg font-medium mb-4">收支趋势</h4>
                        <div class="h-64 bg-gray-50 rounded-lg border border-gray-200 flex items-center justify-center">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 支出分类占比 -->
                    <div>
                        <h4 class="text-lg font-medium mb-4">支出分类占比</h4>
                        <div class="h-64 bg-gray-50 rounded-lg border border-gray-200 flex items-center justify-center">
                            <canvas id="expenseCategoryChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 收入分类占比 -->
                    <div>
                        <h4 class="text-lg font-medium mb-4">收入分类占比</h4>
                        <div class="h-64 bg-gray-50 rounded-lg border border-gray-200 flex items-center justify-center">
                            <canvas id="incomeCategoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold mb-4 flex items-center text-red-500">
                <i class="fa fa-exclamation-triangle mr-2"></i>确认删除
            </h3>
            <p class="mb-6">您确定要删除这条记录吗？此操作无法撤销。</p>
            <div class="flex space-x-3">
                <button id="cancelDeleteBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition-custom">
                    取消
                </button>
                <button id="confirmDeleteBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg transition-custom">
                    确认删除
                </button>
            </div>
        </div>
    </div>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center max-w-sm z-50">
        <i id="notificationIcon" class="mr-3 text-xl"></i>
        <p id="notificationMessage"></p>
    </div>

    <!-- 引入Chart.js用于图表展示 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <script>
        // 收支分类数据 - 已集成扩展的分类列表
        const categories = {
            expense: ['餐饮', '交通', '住房', '购物', '娱乐', '医疗', '教育', '通讯费', '水电费', '其他'],
            income: ['工资', '奖金', '投资收益', '兼职', '礼金', '退款', '其他']
        };
        
        // 全局变量
        let transactions = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredTransactions = [];
        let transactionToDelete = null;
        let trendChart = null;
        let expenseCategoryChart = null;
        let incomeCategoryChart = null;
        
        // DOM元素
        const elements = {
            transactionForm: document.getElementById('transactionForm'),
            transactionId: document.getElementById('transactionId'),
            dateInput: document.getElementById('date'),
            amountInput: document.getElementById('amount'),
            typeRadios: document.querySelectorAll('input[name="type"]'),
            categorySelect: document.getElementById('category'),
            descriptionInput: document.getElementById('description'),
            clearFormBtn: document.getElementById('clearFormBtn'),
            importImageBtn: document.getElementById('importImageBtn'),
            imageUploadSection: document.getElementById('imageUploadSection'),
            imageUpload: document.getElementById('imageUpload'),
            imagePreviewContainer: document.getElementById('imagePreviewContainer'),
            imagePreview: document.getElementById('imagePreview'),
            ocrControls: document.getElementById('ocrControls'),
            processImageBtn: document.getElementById('processImageBtn'),
            ocrProgress: document.getElementById('ocrProgress'),
            ocrProgressBar: document.getElementById('ocrProgressBar'),
            ocrStatus: document.getElementById('ocrStatus'),
            ocrResults: document.getElementById('ocrResults'),
            ocrDate: document.getElementById('ocrDate'),
            ocrAmount: document.getElementById('ocrAmount'),
            ocrType: document.getElementById('ocrType'),
            applyOcrResultsBtn: document.getElementById('applyOcrResultsBtn'),
            transactionsTableBody: document.getElementById('transactionsTableBody'),
            searchInput: document.getElementById('searchInput'),
            filterType: document.getElementById('filterType'),
            shownCount: document.getElementById('shownCount'),
            totalCount: document.getElementById('totalCount'),
            prevPageBtn: document.getElementById('prevPageBtn'),
            nextPageBtn: document.getElementById('nextPageBtn'),
            pageInfo: document.getElementById('pageInfo'),
            statsBtn: document.getElementById('statsBtn'),
            statsModal: document.getElementById('statsModal'),
            closeStatsBtn: document.getElementById('closeStatsBtn'),
            timeFilterBtns: document.querySelectorAll('.time-filter-btn'),
            totalIncome: document.getElementById('totalIncome'),
            totalExpense: document.getElementById('totalExpense'),
            balance: document.getElementById('balance'),
            exportBtn: document.getElementById('exportBtn'),
            deleteModal: document.getElementById('deleteModal'),
            cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),
            confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
            notification: document.getElementById('notification'),
            notificationIcon: document.getElementById('notificationIcon'),
            notificationMessage: document.getElementById('notificationMessage')
        };
        
        // 初始化
        function init() {
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            elements.dateInput.value = today;
            
            // 初始化分类选择框
            populateCategories('expense');
            
            // 加载本地存储的交易记录
            loadTransactions();
            
            // 渲染交易记录表格
            renderTransactions();
            
            // 初始化事件监听器
            initEventListeners();
        }
        
        // 初始化事件监听器
        function initEventListeners() {
            // 表单提交
            elements.transactionForm.addEventListener('submit', handleFormSubmit);
            
            // 清空表单
            elements.clearFormBtn.addEventListener('click', clearForm);
            
            // 切换类型时更新分类
            elements.typeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    populateCategories(e.target.value);
                });
            });
            
            // 导入图片按钮
            elements.importImageBtn.addEventListener('click', () => {
                elements.imageUploadSection.classList.toggle('hidden');
            });
            
            // 图片上传
            elements.imageUpload.addEventListener('change', handleImageUpload);
            
            // 处理图片识别
            elements.processImageBtn.addEventListener('click', processImage);
            
            // 应用OCR结果
            elements.applyOcrResultsBtn.addEventListener('click', applyOcrResults);
            
            // 搜索和筛选
            elements.searchInput.addEventListener('input', filterTransactions);
            elements.filterType.addEventListener('change', filterTransactions);
            
            // 分页
            elements.prevPageBtn.addEventListener('click', goToPrevPage);
            elements.nextPageBtn.addEventListener('click', goToNextPage);
            
            // 统计分析
            elements.statsBtn.addEventListener('click', showStats);
            elements.closeStatsBtn.addEventListener('click', hideStats);
            
            // 时间筛选
            elements.timeFilterBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    elements.timeFilterBtns.forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    e.target.classList.remove('bg-gray-200', 'text-gray-700');
                    e.target.classList.add('bg-primary', 'text-white');
                    updateStats(e.target.dataset.period);
                });
            });
            
            // 导出数据
            elements.exportBtn.addEventListener('click', exportData);
            
            // 删除确认
            elements.cancelDeleteBtn.addEventListener('click', hideDeleteModal);
            elements.confirmDeleteBtn.addEventListener('click', confirmDelete);
        }
        
        // 填充分类选择框
        function populateCategories(type) {
            elements.categorySelect.innerHTML = '';
            
            const categoryList = categories[type];
            categoryList.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                elements.categorySelect.appendChild(option);
            });
        }
        
        // 加载交易记录
        function loadTransactions() {
            const savedTransactions = localStorage.getItem('expenseTrackerTransactions');
            if (savedTransactions) {
                transactions = JSON.parse(savedTransactions);
            } else {
                transactions = [];
            }
        }
        
        // 保存交易记录
        function saveTransactions() {
            localStorage.setItem('expenseTrackerTransactions', JSON.stringify(transactions));
        }
        
        // 处理表单提交
        function handleFormSubmit(e) {
            e.preventDefault();
            
            // 获取表单数据
            const id = elements.transactionId.value;
            const date = elements.dateInput.value;
            const amount = parseFloat(elements.amountInput.value);
            const type = document.querySelector('input[name="type"]:checked').value;
            const category = elements.categorySelect.value;
            const description = elements.descriptionInput.value;
            
            // 验证数据
            if (!date) {
                showNotification('请选择日期', 'error');
                return;
            }
            
            if (isNaN(amount) || amount <= 0) {
                showNotification('请输入有效的金额', 'error');
                return;
            }
            
            // 创建交易对象
            const transaction = {
                date,
                amount,
                type,
                category,
                description,
                createdAt: new Date().toISOString()
            };
            
            if (id) {
                // 更新现有交易
                const index = transactions.findIndex(t => t.id === id);
                if (index !== -1) {
                    transaction.id = id;
                    transactions[index] = transaction;
                    showNotification('记录已更新', 'success');
                }
            } else {
                // 添加新交易
                transaction.id = generateId();
                transactions.unshift(transaction); // 添加到开头
                showNotification('记录已添加', 'success');
            }
            
            // 保存并重新渲染
            saveTransactions();
            filterTransactions();
            clearForm();
        }
        
        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        // 清空表单
        function clearForm() {
            elements.transactionForm.reset();
            elements.transactionId.value = '';
            elements.dateInput.value = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="type"][value="expense"]').checked = true;
            populateCategories('expense');
        }
        
        // 渲染交易记录表格
        function renderTransactions() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            // 清空表格
            elements.transactionsTableBody.innerHTML = '';
            
            if (paginatedTransactions.length === 0) {
                // 显示空状态
                elements.transactionsTableBody.innerHTML = `
                    <tr class="text-center">
                        <td colspan="6" class="px-4 py-12 text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-folder-open-o text-4xl mb-3 text-gray-300"></i>
                                <p>没有找到记录</p>
                                <p class="text-sm mt-1">尝试调整筛选条件</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                // 添加记录行
                paginatedTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-custom';
                    
                    const typeText = transaction.type === 'expense' ? '支出' : '收入';
                    const typeClass = transaction.type === 'expense' ? 'text-expense' : 'text-income';
                    const amountText = transaction.type === 'expense' ? 
                        `-¥${transaction.amount.toFixed(2)}` : 
                        `+¥${transaction.amount.toFixed(2)}`;
                    
                    row.innerHTML = `
                        <td class="px-4 py-4 whitespace-nowrap">${formatDate(transaction.date)}</td>
                        <td class="px-4 py-4 whitespace-nowrap ${typeClass} font-medium">${amountText}</td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full ${transaction.type === 'expense' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${typeText}
                            </span>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">${transaction.category}</td>
                        <td class="px-4 py-4">${transaction.description || '-'}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="edit-btn text-primary hover:text-primary/80 mr-3" data-id="${transaction.id}">
                                <i class="fa fa-pencil"></i> 编辑
                            </button>
                            <button class="delete-btn text-red-500 hover:text-red-600" data-id="${transaction.id}">
                                <i class="fa fa-trash"></i> 删除
                            </button>
                        </td>
                    `;
                    
                    elements.transactionsTableBody.appendChild(row);
                });
                
                // 添加编辑和删除事件监听器
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => editTransaction(btn.dataset.id));
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => showDeleteModal(btn.dataset.id));
                });
            }
            
            // 更新分页信息
            elements.shownCount.textContent = paginatedTransactions.length;
            elements.totalCount.textContent = filteredTransactions.length;
            elements.pageInfo.textContent = `第 ${currentPage} 页`;
            
            // 更新分页按钮状态
            elements.prevPageBtn.disabled = currentPage === 1;
            elements.nextPageBtn.disabled = endIndex >= filteredTransactions.length;
        }
        
        // 格式化日期
        function formatDate(dateString) {
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return new Date(dateString).toLocaleDateString('zh-CN', options);
        }
        
        // 编辑交易记录
        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (transaction) {
                elements.transactionId.value = transaction.id;
                elements.dateInput.value = transaction.date;
                elements.amountInput.value = transaction.amount;
                document.querySelector(`input[name="type"][value="${transaction.type}"]`).checked = true;
                populateCategories(transaction.type);
                
                // 等待DOM更新后设置分类
                setTimeout(() => {
                    elements.categorySelect.value = transaction.category;
                }, 0);
                
                elements.descriptionInput.value = transaction.description || '';
                
                // 滚动到表单
                elements.transactionForm.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // 筛选交易记录
        function filterTransactions() {
            const searchTerm = elements.searchInput.value.toLowerCase();
            const filterType = elements.filterType.value;
            
            filteredTransactions = transactions.filter(transaction => {
                // 类型筛选
                if (filterType !== 'all' && transaction.type !== filterType) {
                    return false;
                }
                
                // 搜索筛选
                if (searchTerm && !transaction.description.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                return true;
            });
            
            // 重置到第一页
            currentPage = 1;
            
            // 重新渲染
            renderTransactions();
        }
        
        // 分页导航
        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTransactions();
            }
        }
        
        function goToNextPage() {
            const maxPage = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (currentPage < maxPage) {
                currentPage++;
                renderTransactions();
            }
        }
        
        // 处理图片上传
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 显示图片预览
            const reader = new FileReader();
            reader.onload = function(event) {
                elements.imagePreview.src = event.target.result;
                elements.imagePreviewContainer.classList.remove('hidden');
                elements.ocrControls.classList.remove('hidden');
                elements.ocrResults.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        // 处理图片识别
        function processImage() {
            // 显示进度条
            elements.ocrProgress.classList.remove('hidden');
            elements.ocrProgressBar.style.width = '0%';
            elements.ocrStatus.textContent = '正在加载OCR引擎...';
            
            // 使用Tesseract.js进行OCR识别
            Tesseract.recognize(
                elements.imagePreview.src,
                ['chi_sim', 'eng'], // 识别中文和英文
                {
                    logger: m => {
                        // 更新进度
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            elements.ocrProgressBar.style.width = `${progress}%`;
                            elements.ocrStatus.textContent = `正在识别: ${progress}%`;
                        }
                    }
                }
            ).then(result => {
                elements.ocrProgressBar.style.width = '100%';
                elements.ocrStatus.textContent = '识别完成';
                
                // 解析识别结果
                const text = result.data.text;
                const parsedData = parseExtractedText(text);
                
                // 显示解析结果
                elements.ocrDate.textContent = parsedData.date || '- 未识别 -';
                elements.ocrAmount.textContent = parsedData.amount ? `¥${parsedData.amount}` : '- 未识别 -';
                elements.ocrType.textContent = parsedData.type || '- 未识别 -';
                
                // 显示结果区域
                setTimeout(() => {
                    elements.ocrResults.classList.remove('hidden');
                }, 500);
                
            }).catch(error => {
                console.error('OCR识别错误:', error);
                elements.ocrStatus.textContent = '识别失败，请重试';
                showNotification('图片识别失败，请重试', 'error');
            });
        }
        
        // 解析提取的文本
        function parseExtractedText(text) {
            const result = {
                date: null,
                amount: null,
                type: null
            };
            
            // 尝试提取日期（支持多种格式）
            const datePatterns = [
                /\d{4}-\d{2}-\d{2}/,  // YYYY-MM-DD
                /\d{4}\/\d{2}\/\d{2}/,  // YYYY/MM/DD
                /\d{2}-\d{2}-\d{4}/,  // DD-MM-YYYY
                /\d{2}\/\d{2}\/\d{4}/,  // DD/MM/YYYY
                /\d{4}年\d{2}月\d{2}日/  // YYYY年MM月DD日
            ];
            
            for (const pattern of datePatterns) {
                const match = text.match(pattern);
                if (match) {
                    let dateStr = match[0];
                    // 转换为YYYY-MM-DD格式
                    if (dateStr.includes('年') && dateStr.includes('月') && dateStr.includes('日')) {
                        dateStr = dateStr.replace('年', '-').replace('月', '-').replace('日', '');
                    } else if (dateStr.includes('/')) {
                        dateStr = dateStr.replace('/', '-');
                    }
                    
                    // 检查日期格式
                    if (dateStr.match(/\d{4}-\d{2}-\d{2}/)) {
                        result.date = dateStr;
                    } else if (dateStr.match(/\d{2}-\d{2}-\d{4}/)) {
                        // 转换DD-MM-YYYY为YYYY-MM-DD
                        const parts = dateStr.split('-');
                        result.date = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    }
                    break;
                }
            }
            
            // 尝试提取金额
            const amountPatterns = [
                /￥\s*(\d+\.?\d*)/,    // ￥123.45 或 ￥ 123
                /¥\s*(\d+\.?\d*)/,    // ¥123.45 或 ¥ 123
                /(\d+\.?\d*)\s*元/,   // 123.45元 或 123 元
                /金额\s*[:：]\s*(\d+\.?\d*)/,  // 金额:123.45 或 金额： 123
            ];
            
            for (const pattern of amountPatterns) {
                const match = text.match(pattern);
                if (match) {
                    try {
                        result.amount = parseFloat(match[1]);
                        break;
                    } catch (e) {
                        continue;
                    }
                }
            }
            
            // 尝试判断是收入还是支出
            const expenseKeywords = ['支出', '消费', '付款', '花费', '扣除', '买', '购', '付', '通讯费', '水电费'];
            const incomeKeywords = ['收入', '进账', '收款', '工资', '奖金', '赚', '收', '礼金', '退款'];
            
            for (const keyword of incomeKeywords) {
                if (text.includes(keyword)) {
                    result.type = '收入';
                    break;
                }
            }
            
            if (!result.type) {
                for (const keyword of expenseKeywords) {
                    if (text.includes(keyword)) {
                        result.type = '支出';
                        break;
                    }
                }
            }
            
            return result;
        }
        
        // 应用OCR识别结果到表单
        function applyOcrResults() {
            const date = elements.ocrDate.textContent !== '- 未识别 -' ? elements.ocrDate.textContent : '';
            const amount = elements.ocrAmount.textContent !== '- 未识别 -' ? 
                elements.ocrAmount.textContent.replace('¥', '') : '';
            const type = elements.ocrType.textContent;
            
            if (date) elements.dateInput.value = date;
            if (amount) elements.amountInput.value = amount;
            if (type === '收入') {
                document.querySelector('input[name="type"][value="income"]').checked = true;
                populateCategories('income');
            } else if (type === '支出') {
                document.querySelector('input[name="type"][value="expense"]').checked = true;
                populateCategories('expense');
            }
            
            // 隐藏图片上传区域，滚动到表单
            elements.imageUploadSection.classList.add('hidden');
            elements.transactionForm.scrollIntoView({ behavior: 'smooth' });
            
            showNotification('已将识别结果应用到表单', 'success');
        }
        
        // 显示统计分析
        function showStats() {
            elements.statsModal.classList.remove('hidden');
            updateStats('month'); // 默认显示本月统计
        }
        
        // 隐藏统计分析
        function hideStats() {
            elements.statsModal.classList.add('hidden');
        }
        
        // 更新统计数据
        function updateStats(period) {
            // 根据时间段筛选交易
            let filteredStatsTransactions = [...transactions];
            
            if (period !== 'all') {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                
                filteredStatsTransactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    
                    if (period === 'month') {
                        // 本月
                        return transactionDate.getFullYear() === year && 
                               transactionDate.getMonth() === month;
                    } else if (period === 'quarter') {
                        // 本季度
                        const currentQuarter = Math.floor(month / 3);
                        const transactionQuarter = Math.floor(transactionDate.getMonth() / 3);
                        return transactionDate.getFullYear() === year && 
                               transactionQuarter === currentQuarter;
                    } else if (period === 'year') {
                        // 本年
                        return transactionDate.getFullYear() === year;
                    }
                    return true;
                });
            }
            
            // 计算总收入、总支出和结余
            const totalIncome = filteredStatsTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const totalExpense = filteredStatsTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const balance = totalIncome - totalExpense;
            
            // 更新统计数字
            elements.totalIncome.textContent = `¥${totalIncome.toFixed(2)}`;
            elements.totalExpense.textContent = `¥${totalExpense.toFixed(2)}`;
            elements.balance.textContent = `¥${balance.toFixed(2)}`;
            
            // 更新图表
            updateTrendChart(filteredStatsTransactions, period);
            updateCategoryCharts(filteredStatsTransactions);
        }
        
        // 更新趋势图表
        function updateTrendChart(transactions, period) {
            // 按时间分组数据
            const groupedData = {};
            
            transactions.forEach(t => {
                let key;
                const date = new Date(t.date);
                
                if (period === 'month') {
                    // 按日
                    key = date.getDate();
                } else if (period === 'quarter') {
                    // 按月
                    key = date.getMonth() + 1;
                } else {
                    // 按 month
                    key = date.getMonth() + 1;
                }
                
                if (!groupedData[key]) {
                    groupedData[key] = { income: 0, expense: 0 };
                }
                
                if (t.type === 'income') {
                    groupedData[key].income += t.amount;
                } else {
                    groupedData[key].expense += t.amount;
                }
            });
            
            // 准备图表数据
            const keys = Object.keys(groupedData).sort((a, b) => a - b);
            const labels = keys.map(key => {
                if (period === 'month') return `${key}日`;
                return `${key}月`;
            });
            
            const incomeData = keys.map(key => groupedData[key].income.toFixed(0));
            const expenseData = keys.map(key => groupedData[key].expense.toFixed(0));
            
            // 销毁现有图表
            if (trendChart) {
                trendChart.destroy();
            }
            
            // 创建新图表
            const ctx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '收入',
                            data: incomeData,
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: '支出',
                            data: expenseData,
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '金额 (¥)'
                            }
                        }
                    }
                }
            });
        }
        
        // 更新分类图表
        function updateCategoryCharts(transactions) {
            // 支出分类数据
            const expenseCategories = {};
            transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    if (!expenseCategories[t.category]) {
                        expenseCategories[t.category] = 0;
                    }
                    expenseCategories[t.category] += t.amount;
                });
            
            // 收入分类数据
            const incomeCategories = {};
            transactions
                .filter(t => t.type === 'income')
                .forEach(t => {
                    if (!incomeCategories[t.category]) {
                        incomeCategories[t.category] = 0;
                    }
                    incomeCategories[t.category] += t.amount;
                });
            
            // 销毁现有图表
            if (expenseCategoryChart) {
                expenseCategoryChart.destroy();
            }
            if (incomeCategoryChart) {
                incomeCategoryChart.destroy();
            }
            
            // 创建支出分类图表
            if (Object.keys(expenseCategories).length > 0) {
                const expenseCtx = document.getElementById('expenseCategoryChart').getContext('2d');
                expenseCategoryChart = new Chart(expenseCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(expenseCategories),
                        datasets: [{
                            data: Object.values(expenseCategories).map(v => v.toFixed(0)),
                            backgroundColor: [
                                '#EF4444', '#F97316', '#EAB308', '#10B981', 
                                '#3B82F6', '#8B5CF6', '#EC4899', '#6B7280', '#84CC16', '#6366F1'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            } else {
                document.getElementById('expenseCategoryChart').getContext('2d').clearRect(
                    0, 0, 
                    document.getElementById('expenseCategoryChart').width, 
                    document.getElementById('expenseCategoryChart').height
                );
                const ctx = document.getElementById('expenseCategoryChart').getContext('2d');
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('暂无支出数据', ctx.canvas.width / 2, ctx.canvas.height / 2);
            }
            
            // 创建收入分类图表
            if (Object.keys(incomeCategories).length > 0) {
                const incomeCtx = document.getElementById('incomeCategoryChart').getContext('2d');
                incomeCategoryChart = new Chart(incomeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(incomeCategories),
                        datasets: [{
                            data: Object.values(incomeCategories).map(v => v.toFixed(0)),
                            backgroundColor: [
                                '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#6B7280', '#84CC16', '#6366F1'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            } else {
                document.getElementById('incomeCategoryChart').getContext('2d').clearRect(
                    0, 0, 
                    document.getElementById('incomeCategoryChart').width, 
                    document.getElementById('incomeCategoryChart').height
                );
                const ctx = document.getElementById('incomeCategoryChart').getContext('2d');
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('暂无收入数据', ctx.canvas.width / 2, ctx.canvas.height / 2);
            }
        }
        
        // 导出数据
        function exportData() {
            if (transactions.length === 0) {
                showNotification('没有数据可导出', 'warning');
                return;
            }
            
            // 转换为CSV格式
            const headers = ['日期', '金额', '类型', '分类', '描述'];
            const csvRows = [
                headers.join(','),
                ...transactions.map(t => {
                    const typeText = t.type === 'expense' ? '支出' : '收入';
                    return [
                        t.date,
                        t.amount,
                        typeText,
                        t.category,
                        t.description || ''
                    ].map(field => `"${field}"`).join(',');
                })
            ];
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            
            // 创建下载链接
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `收支记录_${new Date().toLocaleDateString()}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('数据已导出为CSV文件', 'success');
        }
        
        // 显示删除确认模态框
        function showDeleteModal(id) {
            transactionToDelete = id;
            elements.deleteModal.classList.remove('hidden');
        }
        
        // 隐藏删除确认模态框
        function hideDeleteModal() {
            transactionToDelete = null;
            elements.deleteModal.classList.add('hidden');
        }
        
        // 确认删除
        function confirmDelete() {
            if (transactionToDelete) {
                const index = transactions.findIndex(t => t.id === transactionToDelete);
                if (index !== -1) {
                    transactions.splice(index, 1);
                    saveTransactions();
                    filterTransactions();
                    showNotification('记录已删除', 'success');
                }
            }
            hideDeleteModal();
        }
        
        // 显示通知
        function showNotification(message, type = 'info') {
            elements.notificationMessage.textContent = message;
            
            // 设置通知类型样式
            if (type === 'success') {
                elements.notification.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg bg-green-50 text-green-800 transform translate-y-0 opacity-100 transition-all duration-300 flex items-center max-w-sm z-50';
                elements.notificationIcon.className = 'mr-3 text-xl fa fa-check-circle';
            } else if (type === 'error') {
                elements.notification.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg bg-red-50 text-red-800 transform translate-y-0 opacity-100 transition-all duration-300 flex items-center max-w-sm z-50';
                elements.notificationIcon.className = 'mr-3 text-xl fa fa-exclamation-circle';
            } else if (type === 'warning') {
                elements.notification.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg bg-yellow-50 text-yellow-800 transform translate-y-0 opacity-100 transition-all duration-300 flex items-center max-w-sm z-50';
                elements.notificationIcon.className = 'mr-3 text-xl fa fa-exclamation-triangle';
            } else {
                elements.notification.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg bg-blue-50 text-blue-800 transform translate-y-0 opacity-100 transition-all duration-300 flex items-center max-w-sm z-50';
                elements.notificationIcon.className = 'mr-3 text-xl fa fa-info-circle';
            }
            
            // 3秒后隐藏通知
            setTimeout(() => {
                elements.notification.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center max-w-sm z-50';
            }, 3000);
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
